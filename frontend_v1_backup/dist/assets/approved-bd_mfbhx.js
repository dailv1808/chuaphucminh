import{g as t}from"./config-BvOGzWpZ.js";/* empty css             */import"./auth-BxmWGv8U.js";document.addEventListener("alpine:init",()=>{Alpine.data("approvedData",()=>({registrations:[],filteredRegistrations:[],searchQuery:"",showDetail:!1,selectedRegistration:null,isLoading:!0,isDownloading:!1,showNotification:!1,notificationMessage:"",notificationType:"success",showKutiModal:!1,availableKutis:[],selectedKutiId:null,currentRegistrationId:null,init(){this.fetchRegistrations()},async fetchRegistrations(){try{this.isLoading=!0;const i=await fetch(t("/api/registration/"));if(!i.ok)throw new Error("Lỗi kết nối mạng");const e=await i.json();this.registrations=e.filter(t=>"approved"===t.status),this.filteredRegistrations=[...this.registrations]}catch(i){console.error("Lỗi khi tải danh sách đăng ký:",i),this.showNotificationMessage("Có lỗi xảy ra khi tải dữ liệu","error")}finally{this.isLoading=!1}},async fetchAvailableKutis(i){try{const e=localStorage.getItem("access_token"),s=await fetch(t("/api/kuti/"),{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error("Lỗi kết nối mạng");const o=await s.json();this.availableKutis=o.filter(t=>t.is_available&&("All"===t.gender_allowed||t.gender_allowed===i))}catch(e){console.error("Lỗi khi tải danh sách Kuti:",e),this.showNotificationMessage("Có lỗi xảy ra khi tải danh sách Kuti","error")}},async openCheckInModal(t){this.currentRegistrationId=t.id,await this.fetchAvailableKutis(t.gender),this.showKutiModal=!0},async confirmCheckIn(){if(this.selectedKutiId)try{if(!(await fetch(t("/api/kutiassignment/assign/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registration_id:this.currentRegistrationId,kuti_id:this.selectedKutiId})})).ok)throw new Error("Gán Kuti thất bại");const i=localStorage.getItem("access_token");if(!(await fetch(t(`/api/registration/${this.currentRegistrationId}/`),{method:"PATCH",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({status:"checked_in"})})).ok)throw new Error("Check-in thất bại");this.showNotificationMessage("Check-in thành công","success"),this.showKutiModal=!1,this.selectedKutiId=null,this.fetchRegistrations()}catch(i){console.error("Lỗi check-in:",i),this.showNotificationMessage("Có lỗi xảy ra khi check-in","error")}else this.showNotificationMessage("Vui lòng chọn Kuti","error")},async downloadTemporaryStay(i){try{let s=i;if(this.selectedRegistration&&this.selectedRegistration.id===i.id)s=this.selectedRegistration;else if(!i.cccd||!i.fullname)try{const e=await fetch(t(`/api/registration/${i.id}/`));if(!e.ok)throw new Error("Lỗi khi lấy thông tin chi tiết");s=await e.json()}catch(e){return console.error("Lỗi khi lấy thông tin:",e),this.showRegistrationDetail(i),void this.showNotificationMessage("Vui lòng xem thông tin chi tiết trước khi tải","info")}if(!s.cccd||!s.fullname)return void this.showNotificationMessage("Thông tin CCCD hoặc họ tên bị thiếu","error");this.isDownloading=!0,this.showNotificationMessage("Đang tạo tờ khai tạm trú...","info");const o=localStorage.getItem("access_token"),a=await fetch(t("/api/tamtru/"),{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({username:s.username||"",cccd:s.cccd,fullname:s.fullname,gender:s.gender||"Nam",birthday:s.birthday||(new Date).toISOString().split("T")[0],email:s.email||"",address:s.address||""})});if(!a.ok){const t=await a.text();throw new Error(t||"Lỗi khi tạo tờ khai tạm trú")}const n=a.headers.get("content-disposition");let r=`To_khai_tam_tru_${s.cccd}.docx`;if(n){const t=n.match(/filename="?(.+)"?/);t&&t[1]&&(r=t[1].replace(/"/g,""))}const c=await a.blob(),h=window.URL.createObjectURL(c),l=document.createElement("a");l.href=h,l.download=r,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),window.URL.revokeObjectURL(h)},100),this.showNotificationMessage("Tải tờ khai tạm trú thành công","success")}catch(s){console.error("Lỗi khi tải tờ khai tạm trú:",s),this.showNotificationMessage(s.message||"Có lỗi xảy ra khi tải tờ khai tạm trú","error")}finally{this.isDownloading=!1}},calculateDuration(t,i){if(!t||!i)return 0;const e=new Date(t),s=new Date(i),o=Math.abs(s-e);return Math.ceil(o/864e5)},formatDate(t){if(!t)return"N/A";return new Date(t).toLocaleDateString("vi-VN")},formatStatus:t=>({approved:{text:"Đã duyệt",color:"bg-green-100 text-green-800"},checked_in:{text:"Đã check-in",color:"bg-purple-100 text-purple-800"},checked_out:{text:"Đã check-out",color:"bg-orange-100 text-orange-800"}}[t]||{text:t,color:"bg-gray-100 text-gray-800"}),filterRegistrations(){if(!this.searchQuery)return void(this.filteredRegistrations=[...this.registrations]);const t=this.searchQuery.toLowerCase();this.filteredRegistrations=this.registrations.filter(i=>i.fullname&&i.fullname.toLowerCase().includes(t)||i.username&&i.username.includes(t)||i.cccd&&i.cccd.includes(t)||i.address&&i.address.toLowerCase().includes(t))},showNotificationMessage(t,i="success"){this.notificationMessage=t,this.notificationType=i,this.showNotification=!0,setTimeout(()=>{this.showNotification=!1},3e3)},showRegistrationDetail(t){this.selectedRegistration=t,this.showDetail=!0}}))});
